"use strict";function _defineProperty(i,t,e){return t in i?Object.defineProperty(i,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[t]=e,i}function musicGoing(){var i=music.$mp3,t=i.currentTime,e=1e3*t;if(i.currentTime>=i.duration)return musicStop(),!1;if(i.paused)return!1;for(var n=0,s=music.lrc.list,r=s.length;n<r;n++)if(e>=s[n].time&&(n===r-1||e<s[n+1].time)){if(music.currentID===n)break;music.currentID=n,tm.next();break}requestAnimationFrame(musicGoing)}function musicAction(){music.$mp3.stop=!1,music.$mp3.play(),music.playing=requestAnimationFrame(musicGoing)}function musicStop(){music.$mp3.stop=!0,cancelAnimationFrame(music.playing),$tm.addEventListener("click",function(i){tm.clear(),$tm.classList.add("hide"),tm.setStyle($lovs,{bottom:(music.offset.height-music.offset.width)/2+"px"})},!1)}function musicPause(){music.$mp3.pause(),cancelAnimationFrame(music.playing)}function addWindowListen(){var i,t,e;"undefined"!=typeof document.hidden?(i="hidden",e="visibilitychange",t="visibilityState"):"undefined"!=typeof document.mozHidden?(i="mozHidden",e="mozvisibilitychange",t="mozVisibilityState"):"undefined"!=typeof document.msHidden?(i="msHidden",e="msvisibilitychange",t="msVisibilityState"):"undefined"!=typeof document.webkitHidden&&(i="webkitHidden",e="webkitvisibilitychange",t="webkitVisibilityState"),document.addEventListener(e,function(){music.$mp3.stop===!1&&(document[t]===i?musicPause():musicAction())},!1)}function get(i,t){var e=new XMLHttpRequest;e.open("GET",i),e.onload=function(){200==this.status&&t(this.response)},e.send()}function lrcFormat(i){var t={ti:/\[ti[:：](.*)\]/,ar:/\[ar[:：](.*)\]/,al:/\[al[:：](.*)\]/,by:/\[by[:：](.*)\]/,offset:/\[offset[:：](-?\d*)\]/,rowLyric:/((\[\d+[:：]\d+[\.:：]?\d*\])+)(.*)/,times:/\[\d+[:：]\d+[\.:：]?\d*\]/g,time:/\[(\d+)[:：](\d+)[\.:：]?(\d*)\]/},e={list:[]},n=i.split("\n"),s=void 0;return n.forEach(function(i,n){if(s=i.match(t.ti))e.ti=s[1];else if(s=i.match(t.ar))e.ar=s[1];else if(s=i.match(t.al))e.al=s[1];else if(s=i.match(t.by))e.by=s[1];else if(s=i.match(t.offset))e.offset=s[1];else if(s=i.match(t.rowLyric)){var r=s[3],c=s[1],o=c.match(t.times);o.forEach(function(i,n){var s=i.match(t.time);e.list.push({timeTag:i,m:s[1],s:s[2],ms:s[3],time:60*s[1]*1e3+1e3*s[2]+10*s[3]+(parseInt(e.offset)||0),lrc:r})})}}),e.list.sort(function(i,t){return i.time-t.time}),{data:i,lrc:e}}function shuffle(i){for(var t=i.length,e=0;e<t-1;e++){var n=Math.floor(Math.random()*(t-e)),s=i[n];i[n]=i[t-e-1],i[t-e-1]=s}return i}function getRequest(i){var t=location.search,e={};if(t.indexOf("?")!=-1)for(var n=t.substr(1),s=n.split("&"),r=0;r<s.length;r++)e[s[r].split("=")[0]]=unescape(s[r].split("=")[1]);return void 0!==i?e[i]:e}var $demo=document.getElementById("demo"),$bg=document.getElementById("bg"),$tm=document.getElementById("tm"),$cover=document.getElementById("cover"),$lovs=$bg.querySelector(".lovs");requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;var music={src:"../img/loving/dbb.mp3",lrcSrc:"../img/loving/dbb.lrc",offset:$cover.getBoundingClientRect(),imgs:{index:0,list:[]},init:function(i){this.lrc=i,this.$pre=tm.h("div",{"class":"music-info"},'\n        <div class="con">\n          <div class="ti">\n            <span>'+i.ti+'</span>\n          </div>\n          <div class="ar">\n            <span>by '+i.ar+'</span>\n          </div>\n          <div class="action">\n            <span>开始播放</span>\n          </div>\n        </div>\n      '),this.lovs=[];for(var t=document.createDocumentFragment(),e=0;e<52;e++){var n=tm.h("div",{"class":"lov-l lov-"+(e+1)},String(e+1));this.imgs.list.push(e),this.lovs.push(n),t.appendChild(n)}var s=[29,126],r=[81,143],c=[4,5,10,15,17,23,27,28,36,43,47,48,58,65,72,74,78,79,104,124,125,139,140,143,144,145,146,147,148],o=[0,29,81,126],m=[1,6,11,16,24,30,37,44,51,59,66,75,82,90,96,105,113,127,136],a=i.list.reduce(function(i,t,e){s.findIndex(function(i){return i===e})>-1?i.push({type:"rotate",value:"lb"}):r.findIndex(function(i){return i===e})>-1&&i.push({type:"rotate",value:"rb"});var n={type:"text",value:t.lrc};return c.findIndex(function(i){return i===e})>-1&&(n.color="#fe131a"),m.findIndex(function(i){return i===e})>-1&&(n.color="#00a0e9"),o.findIndex(function(i){return i===e})>-1&&(n.color="#000"),i.push(n),i},[]);shuffle(this.imgs.list),this.imgs.length=this.imgs.list.length,this.imgs.step=~~(i.list.length/this.imgs.length),this.imgs.pre=~~(i.list.length%this.imgs.length/2),this.$pre.addEventListener("click",function(i){$cover.classList.add("hide"),$bg.classList.remove("hide"),tm.init(a),musicAction()},!1);var u=$bg.querySelector(".lovs-list");tm.setStyle(u,_defineProperty({},tm.transform,"scale("+this.offset.width/1200+")")),u.appendChild(t),$cover.appendChild(this.$pre),addWindowListen()}},tm=new TypeMoneky({box:$tm,background:"transparent",beforeCreate:function(i,t,e){var n=music.imgs;n.index<n.length&&t===n.pre+n.index*n.step&&(music.lovs[n.list[n.index]].classList.add("show"),n.index++),i()}});music.$mp3=document.querySelector(".tm-audio"),music.$mp3.src=music.src,music.$mp3.playbackRate=getRequest("play")||1,$demo.appendChild(music.$mp3),get(music.lrcSrc,function(i){music.init(lrcFormat(i).lrc)});