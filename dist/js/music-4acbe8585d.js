"use strict";function musicGoing(){var i=music.$mp3,t=i.currentTime,e=1e3*t;if(i.currentTime>=i.duration)return musicStop(),!1;if(i.paused)return!1;for(var n=0,s=music.lrc.list,c=s.length;n<c;n++)if(e>=s[n].time&&(n===c-1||e<s[n+1].time)){if(music.currentID===n)break;music.currentID=n,tm.next();break}requestAnimationFrame(musicGoing)}function musicAction(){music.$mp3.stop=!1,music.$mp3.play(),music.playing=requestAnimationFrame(musicGoing)}function musicStop(){music.$mp3.stop=!0,cancelAnimationFrame(music.playing),tm.clear(),$cover.classList.remove("hide")}function musicPause(){music.$mp3.pause(),cancelAnimationFrame(music.playing)}function addWindowListen(){var i,t,e;"undefined"!=typeof document.hidden?(i="hidden",e="visibilitychange",t="visibilityState"):"undefined"!=typeof document.mozHidden?(i="mozHidden",e="mozvisibilitychange",t="mozVisibilityState"):"undefined"!=typeof document.msHidden?(i="msHidden",e="msvisibilitychange",t="msVisibilityState"):"undefined"!=typeof document.webkitHidden&&(i="webkitHidden",e="webkitvisibilitychange",t="webkitVisibilityState"),document.addEventListener(e,function(){music.$mp3.stop===!1&&(document[t]===i?musicPause():musicAction())},!1)}function get(i,t){var e=new XMLHttpRequest;e.open("GET",i),e.onload=function(){200==this.status&&t(this.response)},e.send()}function lrcFormat(i){var t={ti:/\[ti[:：](.*)\]/,ar:/\[ar[:：](.*)\]/,al:/\[al[:：](.*)\]/,by:/\[by[:：](.*)\]/,offset:/\[offset[:：](-?\d*)\]/,rowLyric:/((\[\d+[:：]\d+[\.:：]?\d*\])+)(.*)/,times:/\[\d+[:：]\d+[\.:：]?\d*\]/g,time:/\[(\d+)[:：](\d+)[\.:：]?(\d*)\]/},e={list:[]},n=i.split("\n"),s=void 0;return n.forEach(function(i,n){if(s=i.match(t.ti))e.ti=s[1];else if(s=i.match(t.ar))e.ar=s[1];else if(s=i.match(t.al))e.al=s[1];else if(s=i.match(t.by))e.by=s[1];else if(s=i.match(t.offset))e.offset=s[1];else if(s=i.match(t.rowLyric)){var c=s[3],m=s[1],a=m.match(t.times);a.forEach(function(i,n){var s=i.match(t.time);e.list.push({timeTag:i,m:s[1],s:s[2],ms:s[3],time:60*s[1]*1e3+1e3*s[2]+10*s[3]+(parseInt(e.offset)||0),lrc:c})})}}),e.list.sort(function(i,t){return i.time-t.time}),{data:i,lrc:e}}var $demo=document.getElementById("demo"),$tm=document.getElementById("tm"),$cover=document.getElementById("cover"),requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,music={src:"../img/music/csb.mp3",lrcSrc:"../img/music/csb.lrc",init:function(i){this.lrc=i,this.$pre=tm.h("div",{"class":"music-info"},'\n        <div class="con">\n          <div class="ti">\n            <span>'+i.ti+'</span>\n          </div>\n          <div class="ar">\n            <span>'+i.ar+'</span>\n          </div>\n          <div class="lrc-ar">\n            <span>lrc by '+i.by+'</span>\n          </div>\n          <div class="action">\n            <span>开始播放</span>\n          </div>\n        </div>\n      ');var t=[14,41,81,98,104,123],e=[24,66,74,114,130,141],n=[4,9,13,19,25,28,31,35,38,40,50,53,58,60,72,73,87,108,113,125,126,135,136,140,150],s=i.list.reduce(function(i,s,c){t.findIndex(function(i){return i===c})>-1?i.push({type:"rotate",value:"lb"}):e.findIndex(function(i){return i===c})>-1&&i.push({type:"rotate",value:"rb"});var m={type:"text",value:s.lrc};return n.findIndex(function(i){return i===c})>-1&&(m.color="#fe131a"),i.push(m),i},[]);this.$pre.addEventListener("click",function(i){$cover.classList.add("hide"),tm.init(s),musicAction()},!1),addWindowListen(),$cover.appendChild(this.$pre)}},tm=new TypeMoneky({box:$tm,background:"transparent",beforeCreate:function(i,t,e){i()}});music.$mp3=tm.h("audio",{"class":"tm-audio",preload:!0,src:music.src,style:{position:"absolute",visibility:"hidden"}}),$demo.appendChild(music.$mp3),get(music.lrcSrc,function(i){music.init(lrcFormat(i).lrc)});